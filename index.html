<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QU·∫¢N L√ù THI·∫æT B·ªä - BV UNG B∆Ø·ªöU CS2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #003366; --secondary-green: #28a745;
            --light-bg: #f4f7f9; --white: #ffffff;
            --danger: #d32f2f; --warning: #ff9800;
        }
        * { box-sizing: border-box; font-family: "Times New Roman", Times, serif; }
        body { margin: 0; display: flex; height: 100vh; background: var(--light-bg); overflow: hidden; }

        /* Sidebar */
        .sidebar { 
            width: 270px; background: linear-gradient(180deg, #002244 0%, #004080 100%); 
            color: white; flex-shrink: 0; display: flex; flex-direction: column;
            box-shadow: 4px 0 15px rgba(0,0,0,0.3); z-index: 100;
        }
        .sidebar-header { padding: 30px 15px; text-align: center; border-bottom: 2px solid var(--secondary-green); background: rgba(0,0,0,0.2); }
        .sidebar-header h3 { margin: 0; font-size: 20px; letter-spacing: 1px; }
        .sidebar-header p { margin: 8px 0 0; color: #a5d6a7; font-size: 14px; font-weight: bold; }

        .nav-item { padding: 18px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.3s; color: #cfd8dc; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; padding-left: 35px; }
        .nav-item.active { background: var(--secondary-green); color: white; font-weight: bold; }

        #navStatus { background: #7f1d1d; color: #fca5a5; display: none; border-left: 5px solid #ef4444; }
        .nav-bottom { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.2); opacity: 0.8; }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { background: var(--white); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--primary-blue); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .top-bar h2 { margin: 0; color: var(--primary-blue); font-size: 26px; }

        .dashboard { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; padding: 25px; }
        .box-card { padding: 30px 10px; background: var(--white); color: var(--primary-blue); text-align: center; cursor: pointer; transition: 0.3s; font-weight: bold; font-size: 18px; border: 2px solid var(--primary-blue); border-radius: 12px; box-shadow: 0 6px 0px var(--primary-blue); }
        .box-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,51,102,0.2); background: var(--primary-blue); color: white; }

        .card-table { margin: 0 25px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: none; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--primary-blue); color: white; padding: 15px; text-align: left; font-size: 16px; }
        td { padding: 14px; border-bottom: 1px solid #eee; font-size: 16px; }
        tr:hover { background: #f1f8ff; }

        .btn { padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 6px; border: none; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; font-size: 15px; }
        .btn-green { background: var(--secondary-green); color: white; }
        .btn-blue { background: var(--primary-blue); color: white; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,20,40,0.8); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content-lg { background: white; width: 950px; border-radius: 20px; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { background: var(--primary-blue); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 30px; display: grid; grid-template-columns: 280px 1fr; gap: 40px; overflow-y: auto; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #fafafa; padding: 20px; border-radius: 10px; border: 1px solid #eee; }
        .info-item label { font-size: 12px; color: var(--secondary-green); font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .info-item span { font-size: 16px; font-weight: bold; color: #333; }

        .task-card-active { background: #fff5f5; border: 2px dashed var(--danger); padding: 15px; border-radius: 10px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .task-info-red { color: var(--danger); font-weight: bold; font-size: 15px; line-height: 1.5; }

        .checklist-group { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .checklist-group h4 { margin: 0 0 10px 0; color: var(--primary-blue); border-bottom: 2px solid #eee; padding-bottom: 5px; font-size: 15px; }
        .chk-item { display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px dashed #eee; cursor: pointer; }

        .log-entry { background: #f8f9fa; padding: 12px; border-left: 5px solid var(--primary-blue); margin-bottom: 10px; position: relative; border-radius: 4px; border: 1px solid #eee; }
        .log-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 15px; }
        .log-actions i { cursor: pointer; font-size: 16px; color: #bbb; transition: 0.2s; }
        .log-actions i:hover { color: var(--primary-blue); }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--primary-blue); }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header"><h3>BV UNG B∆Ø·ªöU CS2</h3><p>KHOA X√âT NGHI·ªÜM</p></div>
        <div class="nav-item active" id="menuHome" onclick="showDashboard()"><i class="fas fa-home"></i> TRANG CH·ª¶</div>
        <div class="nav-item" id="navStatus" onclick="setFilter('error')"><i class="fas fa-exclamation-triangle"></i> H·ªÜ TH·ªêNG C·∫¢NH B√ÅO</div>
        <div class="nav-item nav-bottom" id="menuAll" onclick="setFilter('all')"><i class="fas fa-database"></i> T·ªîNG THI·∫æT B·ªä</div>
    </div>

    <div class="main">
        <div class="top-bar">
            <h2>H·ªá Th·ªëng Qu·∫£n L√Ω Thi·∫øt B·ªã</h2>
            <button id="btnAddDevice" class="btn btn-green" onclick="openAddModal()">+ TH√äM M√ÅY M·ªöI</button>
        </div>
        
        <div class="content">
            <div id="mainDashboard" class="dashboard">
                <div class="box-card" onclick="setFilter('Huy·∫øt h·ªçc')">HUY·∫æT H·ªåC</div>
                <div class="box-card" onclick="setFilter('Mi·ªÖn d·ªãch')">MI·ªÑN D·ªäCH</div>
                <div class="box-card" onclick="setFilter('Sinh h√≥a')">SINH H√ìA</div>
                <div class="box-card" onclick="setFilter('Vi sinh')">VI SINH</div>
                <div class="box-card" onclick="setFilter('SHPT')">SHPT</div>
            </div>
            
            <div id="tableArea" class="card-table">
                <table>
                    <thead>
                        <tr><th>Nh√≥m</th><th>T√™n Thi·∫øt B·ªã</th><th>M√£ ID</th><th>Model</th><th>Serial</th><th>Tr·∫°ng Th√°i</th><th style="text-align:center">X√≥a</th></tr>
                    </thead>
                    <tbody id="deviceTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content-lg">
            <div class="modal-header">
                <div><h2 id="detName" style="margin:0">T√™n m√°y</h2><small id="detIdSub" style="color:#a5d6a7; font-weight:bold;"></small></div>
                <span onclick="closeModals()" style="cursor:pointer; font-size:35px;">&times;</span>
            </div>
            <div class="modal-body">
                <div style="text-align:center; border-right: 1px solid #eee; padding-right: 25px;">
                    <img id="detQR" style="width:200px; border:5px solid #f0f0f0; border-radius:10px; margin-bottom:20px;">
                    <div id="detStatusBadge" style="font-weight:bold; font-size:18px; margin-bottom:20px;"></div>
                    <button id="btnCheckOpen" class="btn" style="width:100%; margin-bottom:12px; background:#e3f2fd; border:1px solid #2196f3; color:#1565c2;" onclick="openChecklist()">üìã GHI CHECKLIST</button>
                    <button class="btn" style="width:100%; background:#f1f5f9; border:1px solid #ddd;" onclick="openHistoryModal()">üìú NH·∫¨T K√ù CHI TI·∫æT</button>
                </div>
                <div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0; color:var(--primary-blue); font-size:20px; text-decoration: underline;">Th√¥ng Tin Chi Ti·∫øt</h3>
                        <button class="btn btn-blue" style="padding:5px 12px; font-size:13px;" onclick="openEditFromDetail()">S·ª¨A TH√îNG TIN</button>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>Model</label><span id="detModel"></span></div>
                        <div class="info-item"><label>S·ªë Serial</label><span id="detSerial"></span></div>
                        <div class="info-item"><label>V·ªã tr√≠</label><span id="detLocation"></span></div>
                        <div class="info-item"><label>T√¨nh tr·∫°ng</label><span id="detCondition"></span></div>
                        <div class="info-item"><label>H√£ng S·∫£n Xu·∫•t</label><span id="detVendor"></span></div>
                        <div class="info-item"><label>ƒê∆°n v·ªã Cung ·ª©ng</label><span id="detProvider"></span></div>
                        <div class="info-item"><label>Li√™n h·ªá k·ªπ thu·∫≠t</label><span id="detContact"></span></div>
                        <div class="info-item"><label>Ph·ª• tr√°ch</label><span id="detStaff"></span></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:25px;">
                        <button class="btn" style="background:var(--warning); color:white;" onclick="startWork('BT')">üõ† B·∫¢O TR√å</button>
                        <button class="btn" style="background:var(--danger); color:white;" onclick="startWork('SM')">üö® B√ÅO S·ª¨A</button>
                    </div>
                    <div id="activeTaskArea"></div>
                    <div style="margin-top:30px; border-top: 2px solid #eee; padding-top:20px;">
                        <b style="font-size:15px; color: #555;">TRA C·ª®U CHECKLIST:</b>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <input type="date" id="historyDateSelect" onchange="viewPastChecklist()" style="padding:8px; border:1px solid #ddd; border-radius:5px;">
                            <i class="fas fa-history" style="font-size: 24px; color: var(--secondary-green); cursor: pointer;" title="L·ªãch s·ª≠ checklist" onclick="openChecklistHistory()"></i>
                        </div>
                        <div id="historyDetailContent" style="margin-top:15px; font-style:italic; padding:15px; background:#f9f9f9; border-radius:8px; border-left: 5px solid var(--secondary-green);"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="checklistModal" class="modal">
        <div class="modal-content-lg" style="width: 750px;">
            <div class="modal-header"><h3>B·∫¢NG KI·ªÇM B·∫¢O D∆Ø·ª†NG (BMQL.14.05)</h3><span onclick="backToDetail('checklistModal')" style="cursor:pointer; font-size:30px;">&times;</span></div>
            <div style="padding:25px;">
                <div style="display:flex; gap:15px; background:#f1f5f9; padding:15px; border-radius:10px; margin-bottom:15px; align-items:center;">
                    M√£ NV: <input type="text" id="staffCode" placeholder="h5" style="width:80px; padding:8px;">
                    Ng√†y: <input type="date" id="checkDateNow" style="padding:8px;">
                    <button class="btn btn-blue" title="Ch·ªâ t√≠ch nhanh m·ª•c m·ªói ng√†y" onclick="checkDailyOnly()"><i class="fas fa-check-double"></i></button>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <div class="checklist-group">
                        <h4>B·∫¢O D∆Ø·ª†NG M·ªñI NG√ÄY</h4>
                        <label class="chk-item"><input type="checkbox" class="chk-daily"> 1. V·ªá sinh b·ªÅ m·∫∑t v√† ki·ªÉm tra h√≥a ch·∫•t</label>
                        <label class="chk-item"><input type="checkbox" class="chk-daily"> 2. Thay wash solution (76)</label>
                        <label class="chk-item"><input type="checkbox" class="chk-daily"> 3. Thay NaCl 0,9% (78)</label>
                        <label class="chk-item"><input type="checkbox" class="chk-daily"> 4. Thay wash solution 2% (W1 c·∫•p c·ª©u)</label>
                        <label class="chk-item"><input type="checkbox" class="chk-daily"> 5. Thay cleaning solution (c·∫•p c·ª©u)</label>
                        <label class="chk-item"><input type="checkbox" class="chk-daily"> 6. R·ª≠a W1, ISE cleaning, m·ªìi</label>
                        <label class="chk-item"><input type="checkbox" class="chk-daily"> 7. Hi·ªáu chu·∫©n v√† t·∫°o ng√†y m·ªõi</label>
                        <label class="chk-item"><input type="checkbox" class="chk-daily"> 8. N·ªôi ki·ªÉm (QC)</label>
                    </div>
                    <div class="checklist-group">
                        <h4>B·∫¢O D∆Ø·ª†NG M·ªñI TU·∫¶N</h4>
                        <label class="chk-item"><input type="checkbox" class="chk-other"> 1. V·ªá sinh que khu·∫•y, l·ªç NaCl 0,9%, c·∫£m bi·∫øn, gi·∫øng m·∫´u</label>
                        <label class="chk-item"><input type="checkbox" class="chk-other"> 2. Thay NaOH 0,1M, r·ª≠a W2</label>
                        <label class="chk-item"><input type="checkbox" class="chk-other"> 3. Thay HCl 1M (ho·∫∑c ISE cleaning 10%), r·ª≠a W2</label>
                    </div>
                    <div class="checklist-group">
                        <h4>B·∫¢O D∆Ø·ª†NG M·ªñI TH√ÅNG / QU√ù</h4>
                        <label class="chk-item"><input type="checkbox" class="chk-other"> 1. Thay b√≥ng ƒë√®n halogen (Th√°ng)</label>
                        <label class="chk-item"><input type="checkbox" class="chk-other"> 2. V·ªá sinh tr·∫°m r·ª≠a cuvette, gi·∫øng r·ª≠a que khu·∫•y (Th√°ng)</label>
                        <label class="chk-item"><input type="checkbox" class="chk-other"> 3. Ki·ªÉm tra c·ªôt l·ªçc n∆∞·ªõc kh·ª≠ ion (Th√°ng)</label>
                        <label class="chk-item"><input type="checkbox" class="chk-other"> 4. Thay d√¢y b∆°m detergent (Qu√Ω)</label>
                    </div>
                </div>
                <button class="btn btn-green" style="width:100%; margin-top:20px; padding:15px;" onclick="saveChecklist()">X√ÅC NH·∫¨N HO√ÄN TH√ÄNH</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content-lg" style="width: 850px;">
            <div class="modal-header"><h3>NH·∫¨T K√ù THI·∫æT B·ªä</h3><span onclick="backToDetail('historyModal')" style="cursor:pointer; font-size:30px;">&times;</span></div>
            <div style="padding:25px; display:grid; grid-template-columns: 1fr 1fr; gap:25px;">
                <div style="border:1px solid #eee; padding:15px; border-radius:10px;">
                    <h4 style="color:var(--primary-blue); border-bottom: 2px solid var(--primary-blue);">üõ† B·∫¢O TR√å</h4>
                    <div id="histBT" style="max-height: 450px; overflow-y:auto;"></div>
                </div>
                <div style="border:1px solid #eee; padding:15px; border-radius:10px;">
                    <h4 style="color:var(--danger); border-bottom: 2px solid var(--danger);">üö® S·ª¨A M√ÅY</h4>
                    <div id="histSM" style="max-height: 450px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="checklistHistoryModal" class="modal">
        <div class="modal-content-lg" style="width: 650px;">
            <div class="modal-header"><h3>L·ªäCH S·ª¨ CHECKLIST</h3><span onclick="backToDetail('checklistHistoryModal')" style="cursor:pointer; font-size:30px;">&times;</span></div>
            <div id="checklistHistoryBody" style="padding: 20px; overflow-y: auto; max-height: 70vh;"></div>
        </div>
    </div>

    <div id="formModal" class="modal">
        <div class="modal-content-lg" style="width: 750px;">
            <div class="modal-header"><h2 id="formTitle">D·ªÆ LI·ªÜU THI·∫æT B·ªä</h2><span onclick="closeModals()" style="cursor:pointer; font-size:30px;">&times;</span></div>
            <form id="deviceForm" style="padding:30px; display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <input type="hidden" id="editKey">
                <div class="form-group" style="grid-column: span 2;"><label>T√™n m√°y</label><input type="text" id="fName" required></div>
                <div class="form-group"><label>M√£ ID</label><input type="text" id="fId" required></div>
                <div class="form-group"><label>Nh√≥m m√°y</label><select id="fGroup"><option value="Sinh h√≥a">Sinh h√≥a</option><option value="Huy·∫øt h·ªçc">Huy·∫øt h·ªçc</option><option value="Mi·ªÖn d·ªãch">Mi·ªÖn d·ªãch</option><option value="Vi sinh">Vi sinh</option><option value="SHPT">SHPT</option></select></div>
                <div class="form-group"><label>Model</label><input type="text" id="fModel"></div>
                <div class="form-group"><label>S·ªë Serial</label><input type="text" id="fSerial"></div>
                <div class="form-group"><label>V·ªã tr√≠</label><input type="text" id="fLocation"></div>
                <div class="form-group"><label>T√¨nh tr·∫°ng</label><input type="text" id="fCondition"></div>
                <div class="form-group"><label>H√£ng SX</label><input type="text" id="fVendor"></div>
                <div class="form-group"><label>ƒê∆°n v·ªã Cung ·ª©ng</label><input type="text" id="fProvider"></div>
                <div class="form-group"><label>Li√™n h·ªá k·ªπ thu·∫≠t</label><input type="text" id="fContact"></div>
                <div class="form-group"><label>Ph·ª• tr√°ch</label><input type="text" id="fStaff"></div>
                <div style="grid-column: span 2;"><button type="submit" class="btn btn-green" style="width:100%; padding:15px; font-size:18px;">L∆ØU D·ªÆ LI·ªÜU</button></div>
            </form>
        </div>
    </div>

    <script>
        const API = "https://quanlymay-c28d9-default-rtdb.firebaseio.com/devices";
        const WEB = "https://hautruong339-blip.github.io/maychinh/"; 
        let deviceData = {}; let activeKey = ""; let currentFilter = "all";

        function getVNTimeDate() {
            const now = new Date();
            const vnTime = new Date(now.getTime() + (7 * 60 * 60 * 1000));
            return vnTime.toISOString().split('T')[0];
        }

        async function loadData(refreshModal = false) {
            try {
                const res = await fetch(`${API}.json`);
                deviceData = await res.json() || {};
                checkSystemStatus();
                renderTable();
                if (refreshModal && activeKey) showDetail(activeKey);
            } catch (e) { console.error(e); }
        }

        function checkSystemStatus() {
            const hasError = Object.values(deviceData).some(d => !d.isOnline);
            document.getElementById('navStatus').style.display = hasError ? 'flex' : 'none';
        }

        function renderTable() {
            const tbody = document.getElementById('deviceTableBody'); tbody.innerHTML = "";
            const keys = Object.keys(deviceData).sort((a,b) => deviceData[a].group.localeCompare(deviceData[b].group));
            keys.forEach(key => {
                const d = deviceData[key];
                if (currentFilter === 'error' && d.isOnline) return;
                if (currentFilter !== 'all' && currentFilter !== 'error' && d.group !== currentFilter) return;

                // LOGIC PH√ÇN BI·ªÜT TR·∫†NG TH√ÅI HI·ªÇN TH·ªä CH·∫§M ƒê·ªé
                let statusText = "S·∫µn S√†ng";
                let color = "green";
                if(!d.isOnline) {
                    color = "red";
                    const activeLog = Object.values(d.logs || {}).find(l => !l.end);
                    if(activeLog && activeLog.type === "B·∫£o tr√¨") statusText = "B·∫£o tr√¨";
                    else statusText = "ƒêang x·ª≠ l√Ω";
                }

                tbody.innerHTML += `<tr onclick="showDetail('${key}')">
                    <td><span style="background:var(--primary-blue); color:white; padding:3px 8px; border-radius:5px; font-weight:bold;">${d.group}</span></td>
                    <td><b>${d.name}</b></td><td><code>${d.id}</code></td><td>${d.model}</td><td>${d.serial || '-'}</td>
                    <td style="color:${color}; font-weight:bold;">‚óè ${statusText}</td>
                    <td style="text-align:center;"><i class="fas fa-trash-alt" style="color:#ddd; cursor:pointer;" onclick="event.stopPropagation(); deleteDevice('${key}')"></i></td>
                </tr>`;
            });
        }

        function showDetail(key) {
            activeKey = key; const d = deviceData[key];
            document.getElementById('detName').innerText = d.name;
            document.getElementById('detIdSub').innerText = "S·ªë hi·ªáu ID: " + d.id;
            document.getElementById('detQR').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(WEB+"?id="+d.id)}`;
            
            document.getElementById('detModel').innerText = d.model || "-";
            document.getElementById('detSerial').innerText = d.serial || "-";
            document.getElementById('detLocation').innerText = d.location || "-";
            document.getElementById('detCondition').innerText = d.condition || "-";
            document.getElementById('detVendor').innerText = d.vendor || "-";
            document.getElementById('detProvider').innerText = d.provider || "-";
            document.getElementById('detContact').innerText = d.contact || "-";
            document.getElementById('detStaff').innerText = d.staff || "-";
            
            document.getElementById('detStatusBadge').innerHTML = d.isOnline ? 
                '<span style="color:var(--secondary-green)">‚óè M√ÅY ƒêANG S·∫¥N S√ÄNG</span>' : 
                '<span style="color:var(--danger)">‚óè ƒêANG C√ì L·ªñI/B·∫¢O TR√å</span>';
            
            document.getElementById('btnCheckOpen').style.display = (d.group === 'Sinh h√≥a') ? 'block' : 'none';
            
            const taskDiv = document.getElementById('activeTaskArea'); taskDiv.innerHTML = "";
            if(d.logs) {
                const activeTasks = Object.entries(d.logs).filter(([id, l]) => !l.end);
                activeTasks.forEach(([lId, lData]) => {
                    let info = lData.type === 'B·∫£o tr√¨' ? `B·∫¢O TR√å: ${lData.tech} (${lData.start})` : `S·ª¨A M√ÅY: ${lData.tech} - ${lData.note} (${lData.start})`;
                    taskDiv.innerHTML += `<div class="task-card-active"><div class="task-info-red">${info}</div><button class="btn btn-green" onclick="finishWork('${lId}')">HO√ÄN T·∫§T</button></div>`;
                });
            }
            document.getElementById('historyDateSelect').value = getVNTimeDate();
            viewPastChecklist();
            document.getElementById('detailModal').style.display = 'flex';
        }

        function backToDetail(currentModalId) {
            document.getElementById(currentModalId).style.display = 'none';
            document.getElementById('detailModal').style.display = 'flex';
        }

        async function startWork(type) {
            let tech = prompt("T√™n k·ªπ s∆∞ th·ª±c hi·ªán:"); if(!tech) return;
            let note = "ƒêang x·ª≠ l√Ω"; if(type === 'SM') { note = prompt("L√Ω do h·ªèng:"); if(!note) return; }
            const log = { type: type==='BT'?'B·∫£o tr√¨':'S·ª≠a m√°y', tech, note, start: new Date().toLocaleString('vi-VN'), end: null };
            await fetch(`${API}/${activeKey}/isOnline.json`, { method: 'PUT', body: "false" });
            await fetch(`${API}/${activeKey}/logs.json`, { method: 'POST', body: JSON.stringify(log) });
            loadData(true);
        }

        async function finishWork(id) {
            await fetch(`${API}/${activeKey}/logs/${id}/end.json`, { method: 'PUT', body: JSON.stringify(new Date().toLocaleString('vi-VN')) });
            const res = await fetch(`${API}/${activeKey}/logs.json`);
            const currentLogs = await res.json() || {};
            if(!Object.values(currentLogs).some(l => !l.end)) await fetch(`${API}/${activeKey}/isOnline.json`, { method: 'PUT', body: "true" });
            loadData(true);
        }

        function viewPastChecklist() {
            const date = document.getElementById('historyDateSelect').value;
            const log = Object.values(deviceData[activeKey].logs || {}).find(l => l.fullDate === date && l.type === 'Checklist');
            document.getElementById('historyDetailContent').innerHTML = log ? `<b>NV ${log.tech}:</b> Checklist l√†m l√∫c ${log.start.split(' ')[1]}.` : `Ch∆∞a l√†m checklist ng√†y n√†y.`;
        }

        function openChecklistHistory() {
            const d = deviceData[activeKey]; let html = "";
            Object.entries(d.logs || {}).filter(([id,l]) => l.type==='Checklist').reverse().forEach(([id,l]) => {
                html += `<div style='border-left:5px solid var(--secondary-green); background:#f9f9f9; padding:15px; margin-bottom:10px; position:relative;'><b>Ng√†y: ${l.fullDate}</b> - NV: ${l.tech}<i class='fas fa-trash-alt' style='position:absolute; right:15px; color:#ddd; cursor:pointer;' onclick='deleteLog("${id}")'></i></div>`;
            });
            document.getElementById('checklistHistoryBody').innerHTML = html || "Tr·ªëng";
            document.getElementById('detailModal').style.display = 'none';
            document.getElementById('checklistHistoryModal').style.display = 'flex';
        }

        function openChecklist() { 
            document.getElementById('checkDateNow').value = getVNTimeDate(); 
            document.querySelectorAll('.chk-daily, .chk-other').forEach(c => c.checked = false); 
            document.getElementById('detailModal').style.display = 'none';
            document.getElementById('checklistModal').style.display = 'flex'; 
        }

        function checkDailyOnly() { document.querySelectorAll('.chk-daily').forEach(c => c.checked = true); }

        async function saveChecklist() {
            const tech = document.getElementById('staffCode').value; if(!tech) return alert("Nh·∫≠p M√£ NV!");
            const log = { type: 'Checklist', tech, fullDate: document.getElementById('checkDateNow').value, start: new Date().toLocaleString('vi-VN'), end: new Date().toLocaleString('vi-VN') };
            await fetch(`${API}/${activeKey}/logs.json`, { method: 'POST', body: JSON.stringify(log) });
            backToDetail('checklistModal'); loadData(true);
        }

        function openHistoryModal() {
            const d = deviceData[activeKey]; let hBT="", hSM="";
            Object.entries(d.logs || {}).reverse().forEach(([id,l]) => {
                if(l.type === 'Checklist') return;
                const row = `<div class='log-entry'>
                                <div class='log-actions'><i class='fas fa-edit' onclick='editLog("${id}")'></i><i class='fas fa-trash-alt' onclick='deleteLog("${id}")'></i></div>
                                <b>${l.tech}</b> (${l.start})<br>${l.note}
                             </div>`;
                if(l.type==='B·∫£o tr√¨') hBT += row; else hSM += row;
            });
            document.getElementById('histBT').innerHTML = hBT || "Tr·ªëng"; document.getElementById('histSM').innerHTML = hSM || "Tr·ªëng";
            document.getElementById('detailModal').style.display = 'none';
            document.getElementById('historyModal').style.display='flex';
        }

        async function editLog(id) {
            const log = deviceData[activeKey].logs[id];
            const newTech = prompt("S·ª≠a T√™n K·ªπ S∆∞:", log.tech); if(newTech === null) return;
            const newNote = prompt("S·ª≠a N·ªôi dung / L√Ω do:", log.note); if(newNote === null) return;
            const newTime = prompt("S·ª≠a Ng√†y gi·ªù:", log.start); if(newTime === null) return;
            const updates = { tech: newTech, note: newNote, start: newTime };
            await fetch(`${API}/${activeKey}/logs/${id}.json`, { method: 'PATCH', body: JSON.stringify(updates) });
            loadData(true); openHistoryModal();
        }

        async function deleteLog(id) { if(confirm("X√≥a d√≤ng nh·∫≠t k√Ω n√†y?")) { await fetch(`${API}/${activeKey}/logs/${id}.json`, { method: 'DELETE' }); loadData(true); if(document.getElementById('historyModal').style.display==='flex') openHistoryModal(); if(document.getElementById('checklistHistoryModal').style.display==='flex') openChecklistHistory(); } }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
        function showDashboard() { currentFilter = 'all'; document.getElementById('mainDashboard').style.display='grid'; document.getElementById('tableArea').style.display='none'; document.getElementById('btnAddDevice').style.display='none'; }
        function setFilter(f) { currentFilter = f; document.getElementById('mainDashboard').style.display='none'; document.getElementById('tableArea').style.display='block'; document.getElementById('btnAddDevice').style.display = f==='all'?'block':'none'; renderTable(); }
        async function deleteDevice(k) { if(confirm("X√≥a m√°y?")) { await fetch(`${API}/${k}.json`, { method: 'DELETE' }); loadData(); } }
        function openAddModal() { document.getElementById('deviceForm').reset(); document.getElementById('editKey').value=""; document.getElementById('fStaff').value = "Tr∆∞∆°ng C√¥ng H·∫≠u (0934187801)"; document.getElementById('formModal').style.display='flex'; }
        function openEditFromDetail() { 
            const d = deviceData[activeKey]; document.getElementById('editKey').value = activeKey;
            document.getElementById('fName').value = d.name; document.getElementById('fId').value = d.id;
            document.getElementById('fGroup').value = d.group; document.getElementById('fModel').value = d.model || "";
            document.getElementById('fSerial').value = d.serial || ""; document.getElementById('fLocation').value = d.location || "";
            document.getElementById('fCondition').value = d.condition || ""; document.getElementById('fVendor').value = d.vendor || "";
            document.getElementById('fProvider').value = d.provider || ""; document.getElementById('fContact').value = d.contact || "";
            document.getElementById('fStaff').value = d.staff || "";
            document.getElementById('detailModal').style.display='none'; document.getElementById('formModal').style.display='flex'; 
        }
        document.getElementById('deviceForm').onsubmit = async (e) => {
            e.preventDefault(); const key = document.getElementById('editKey').value;
            const payload = { 
                name: document.getElementById('fName').value, id: document.getElementById('fId').value, group: document.getElementById('fGroup').value, 
                model: document.getElementById('fModel').value, serial: document.getElementById('fSerial').value, location: document.getElementById('fLocation').value, 
                condition: document.getElementById('fCondition').value, vendor: document.getElementById('fVendor').value, provider: document.getElementById('fProvider').value, 
                contact: document.getElementById('fContact').value, staff: document.getElementById('fStaff').value, isOnline: key ? deviceData[key].isOnline : true, logs: key ? (deviceData[key].logs || {}) : {} 
            };
            if(key) await fetch(`${API}/${key}.json`, { method: 'PUT', body: JSON.stringify(payload) });
            else await fetch(`${API}.json`, { method: 'POST', body: JSON.stringify(payload) });
            closeModals(); loadData(true);
        };
        loadData();
    </script>
</body>
</html>
