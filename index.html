<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BV UNG B∆Ø·ªöU CS2 - KHOA X√âT NGHI·ªÜM v81</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #003366; --sidebar-bg: #1e293b; --border: #cccccc;
            --danger: #cc0000; --warning: #ff9900; --success: #28a745;
        }
        * { box-sizing: border-box; font-family: "Times New Roman", Times, serif; }
        body { margin: 0; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }

        /* Sidebar Navigation */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.3s; color: #cbd5e1; }
        .nav-item:hover, .nav-item.active { background: #0055a5; color: white; }
        .nav-status { background: var(--danger); font-weight: bold; border-left: 5px solid #fff; }

        /* Main Area */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary-blue); }
        .content { padding: 20px; overflow-y: auto; flex: 1; }

        /* Dashboard Boxes */
        .dashboard { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px; }
        .box-card { padding: 25px 10px; border-radius: 8px; color: white; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .box-card:hover { transform: scale(1.03); }

        /* Table Style */
        .card-table { background: white; border-radius: 8px; border: 1px solid var(--border); overflow: hidden; display: none; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 12px; text-align: left; color: var(--primary-blue); border-bottom: 2px solid var(--border); font-size: 13px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 15px; }

        /* Modal Layout */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: #fff; width: 950px; border-radius: 10px; overflow: hidden; position: relative; max-height: 95vh; display: flex; flex-direction: column; }
        .modal-header { background: var(--primary-blue); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; display: grid; grid-template-columns: 280px 1fr; gap: 30px; overflow-y: auto; }
        
        .qr-section { background: #f8f9fa; border: 1px solid #ddd; padding: 20px; border-radius: 8px; text-align: center; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fff; }
        .info-item label { font-size: 11px; color: #666; font-weight: bold; display: block; text-transform: uppercase; margin-bottom: 2px; }
        .info-item span { font-size: 14px; font-weight: bold; color: #000; }

        /* Nh·∫≠t k√Ω 2 c·ªôt */
        .history-layer { display: none; position: absolute; inset: 0; background: white; z-index: 100; padding: 30px; overflow-y: auto; }
        .history-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .log-column { border: 1px solid #eee; padding: 15px; border-radius: 8px; }
        .log-entry { background: #f8f9fa; padding: 12px; border-left: 4px solid var(--primary-blue); margin-bottom: 10px; position: relative; border-radius: 4px; }
        .log-actions { position: absolute; top: 8px; right: 10px; display: flex; gap: 12px; }
        .log-actions i { cursor: pointer; font-size: 14px; color: #666; }

        .btn { padding: 10px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .task-item { background: #fff5f5; border: 1px solid var(--danger); border-left: 5px solid var(--danger); padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header"><h3>BV UNG B∆Ø·ªöU CS2</h3><p style="font-size:12px;">KHOA X√âT NGHI·ªÜM</p></div>
        <div class="nav-item" onclick="showDashboard()"><i class="fas fa-home"></i> TRANG CH·ª¶</div>
        <div class="nav-item" onclick="setFilter('status_center')"><i class="fas fa-tools"></i> TR·∫†NG TH√ÅI THI·∫æT B·ªä</div>
        <div style="flex:1"></div>
        <div class="nav-item" onclick="setFilter('all')"><i class="fas fa-database"></i> T·ªîNG THI·∫æT B·ªä</div>
    </div>

    <div class="main">
        <div class="top-bar">
            <h2 id="pageTitle" style="color: var(--primary-blue); margin:0;">QU·∫¢N L√ù THI·∫æT B·ªä</h2>
            <button id="globalAddBtn" class="btn" style="background:var(--success); color:white;" onclick="openAddModal()">+ TH√äM M√ÅY M·ªöI</button>
        </div>
        <div class="content">
            <div id="mainDashboard" class="dashboard">
                <div class="box-card" style="background:#cc0000" onclick="setFilter('Huy·∫øt h·ªçc')"><h3>HUY·∫æT H·ªåC</h3></div>
                <div class="box-card" style="background:#0055a5" onclick="setFilter('Mi·ªÖn d·ªãch')"><h3>MI·ªÑN D·ªäCH</h3></div>
                <div class="box-card" style="background:#28a745" onclick="setFilter('Sinh h√≥a')"><h3>SINH H√ìA</h3></div>
                <div class="box-card" style="background:#ff9900" onclick="setFilter('Vi sinh')"><h3>VI SINH</h3></div>
                <div class="box-card" style="background:#660099" onclick="setFilter('SHPT')"><h3>SHPT</h3></div>
            </div>
            <div id="tableArea" class="card-table">
                <table>
                    <thead><tr><th>NH√ìM</th><th>T√äN THI·∫æT B·ªä</th><th>M√É ID</th><th>MODEL</th><th>SERIAL</th><th>TR·∫†NG TH√ÅI</th><th>X√ìA</th></tr></thead>
                    <tbody id="deviceTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div id="historyLayer" class="history-layer">
                <div style="display:flex; justify-content:space-between; border-bottom:2px solid var(--primary-blue); margin-bottom:15px; padding-bottom:10px;">
                    <h3>L·ªäCH S·ª¨ B·∫¢O TR√å & S·ª¨A CH·ªÆA</h3>
                    <button class="btn" onclick="toggleHistory(false)">ƒê√ìNG</button>
                </div>
                <div class="history-grid">
                    <div class="log-column"><h4 style="color:var(--warning); text-align:center;">üõ† B·∫¢O TR√å</h4><div id="histBT"></div></div>
                    <div class="log-column"><h4 style="color:var(--danger); text-align:center;">üö® S·ª¨A CH·ªÆA</h4><div id="histSM"></div></div>
                </div>
            </div>

            <div class="modal-header">
                <div><h2 id="detName" style="margin:0">T√™n m√°y</h2><small id="detIdSub"></small></div>
                <span onclick="closeModals()" style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div class="modal-body">
                <div class="qr-section">
                    <img id="detQR" style="width:180px; border:1px solid #ddd; padding:5px; border-radius:10px; background:white;">
                    <div id="detStatusBadge" style="font-weight:bold; margin:15px 0;"></div>
                    <button class="btn" style="width:100%; border:1px solid #ddd; margin-bottom:10px;" onclick="printLabel()">üñ® IN TEM QR (M·ªû WEB)</button>
                    <button class="btn" style="width:100%; border:1px solid #ddd;" onclick="toggleHistory(true)">üìú XEM/S·ª¨A NH·∫¨T K√ù</button>
                </div>
                <div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="color:var(--primary-blue); margin:0;">TH√îNG TIN CHI TI·∫æT</h3>
                        <button class="btn" style="padding:4px 10px; font-size:11px; border:1px solid #ddd;" onclick="openEditFromDetail()">S·ª¨A</button>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>Model</label><span id="detModel"></span></div>
                        <div class="info-item"><label>S·ªë Serial</label><span id="detSerial"></span></div>
                        <div class="info-item"><label>V·ªã tr√≠</label><span id="detLocation"></span></div>
                        <div class="info-item"><label>H√£ng S·∫£n Xu·∫•t</label><span id="detVendor"></span></div>
                        <div class="info-item"><label>ƒê∆°n v·ªã Cung ·ª©ng</label><span id="detProvider"></span></div>
                        <div class="info-item"><label>Li√™n h·ªá k·ªπ thu·∫≠t</label><span id="detContact"></span></div>
                        <div class="info-item"><label>Ph·ª• tr√°ch</label><span id="detStaff"></span></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                        <button class="btn" style="background:var(--warning); color:white;" onclick="startWork('BT')">B·∫¢O TR√å</button>
                        <button class="btn" style="background:var(--danger); color:white;" onclick="startWork('SM')">S·ª¨A M√ÅY</button>
                    </div>
                    <div id="currentTaskList" style="margin-top:15px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="editLogModal" class="modal" style="z-index:3000;">
        <div class="modal-content" style="width: 400px; padding: 25px;">
            <h3>S·ª¨A D√íNG NH·∫¨T K√ù</h3>
            <label>K·ªπ s∆∞:</label><input type="text" id="elTech" style="width:100%; padding:8px; margin-bottom:10px;">
            <label>N·ªôi dung:</label><input type="text" id="elNote" style="width:100%; padding:8px; margin-bottom:10px;">
            <label>B·∫Øt ƒë·∫ßu:</label><input type="text" id="elStart" style="width:100%; padding:8px; margin-bottom:10px;">
            <label>K·∫øt th√∫c:</label><input type="text" id="elEnd" style="width:100%; padding:8px; margin-bottom:10px;">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:var(--success); color:white; flex:1;" onclick="saveEditedLog()">L∆ØU</button>
                <button class="btn" style="flex:1;" onclick="document.getElementById('editLogModal').style.display='none'">H·ª¶Y</button>
            </div>
        </div>
    </div>

    <div id="formModal" class="modal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header"><h2>Th√¥ng tin m√°y</h2><span onclick="closeModals()">&times;</span></div>
            <form id="deviceForm" style="padding:20px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <input type="hidden" id="editKey">
                <div style="grid-column: span 2;"><label>T√™n thi·∫øt b·ªã</label><input type="text" id="fName" style="width:100%; padding:8px;" required></div>
                <div><label>M√£ ID</label><input type="text" id="fId" style="width:100%; padding:8px;" required></div>
                <div><label>Nh√≥m</label><select id="fGroup" style="width:100%; padding:10px;"><option value="Huy·∫øt h·ªçc">Huy·∫øt h·ªçc</option><option value="Mi·ªÖn d·ªãch">Mi·ªÖn d·ªãch</option><option value="Sinh h√≥a">Sinh h√≥a</option><option value="Vi sinh">Vi sinh</option><option value="SHPT">SHPT</option></select></div>
                <div><label>Model</label><input type="text" id="fModel" style="width:100%; padding:8px;"></div>
                <div><label>S·ªë Serial</label><input type="text" id="fSerial" style="width:100%; padding:8px;"></div>
                <div><label>V·ªã tr√≠</label><input type="text" id="fLocation" style="width:100%; padding:8px;"></div>
                <div><label>H√£ng S·∫£n Xu·∫•t</label><input type="text" id="fVendor" style="width:100%; padding:8px;"></div>
                <div><label>ƒê∆°n v·ªã Cung ·ª©ng</label><input type="text" id="fProvider" style="width:100%; padding:8px;"></div>
                <div><label>Li√™n h·ªá k·ªπ thu·∫≠t</label><input type="text" id="fContact" style="width:100%; padding:8px;"></div>
                <div><label>Ph·ª• tr√°ch</label><input type="text" id="fStaff" style="width:100%; padding:8px;"></div>
                <div style="grid-column: span 2;"><button type="submit" class="btn" style="background:var(--primary-blue); color:white; width:100%;">L∆ØU THAY ƒê·ªîI</button></div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://quanlymay-c28d9-default-rtdb.firebaseio.com/devices";
        // C·∫¨P NH·∫¨T ƒê·ªäA CH·ªà WEB GITHUB C·ª¶A B·∫†N T·∫†I ƒê√ÇY
        const WEB_URL = "https://hautruong339-blip.github.io/maychinh/";
        let deviceData = {}; let activeKey = ""; let currentFilter = "all"; let editingLogId = "";

        async function loadData(refreshModal = false) {
            const res = await fetch(`${API_URL}.json`);
            deviceData = await res.json() || {};
            renderTable();
            if (refreshModal && activeKey) showDetail(activeKey);
        }

        function renderTable() {
            const tbody = document.getElementById('deviceTableBody'); tbody.innerHTML = "";
            const sortedKeys = Object.keys(deviceData).sort((a, b) => (deviceData[a].group || "").localeCompare(deviceData[b].group || ""));
            sortedKeys.forEach(key => {
                const d = deviceData[key];
                if (currentFilter === 'status_center' && d.isOnline) return;
                if (currentFilter !== 'all' && currentFilter !== 'status_center' && d.group !== currentFilter) return;
                tbody.innerHTML += `<tr onclick="showDetail('${key}')"><td><b>${d.group}</b></td><td>${d.name}</td><td><code>${d.id}</code></td><td>${d.model || '-'}</td><td>${d.serial || '-'}</td><td style="color:${d.isOnline?'green':'red'}">‚óè ${d.isOnline?'S·∫µn s√†ng':'ƒêang x·ª≠ l√Ω'}</td><td style="text-align:center;"><i class="fas fa-trash" style="color:red;" onclick="event.stopPropagation(); deleteDevice('${key}')"></i></td></tr>`;
            });
        }

        function showDetail(key) {
            activeKey = key; const d = deviceData[key];
            document.getElementById('detName').innerText = d.name;
            document.getElementById('detIdSub').innerText = "M√£ ID: " + d.id;
            
            // TO√ÄN B·ªò M√É QR ƒê·ªÄU L√Ä LINK WEB D·∫™N ƒê·∫æN TRANG CHI TI·∫æT
            const fullLink = WEB_URL + "?id=" + d.id;
            document.getElementById('detQR').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(fullLink)}`;
            
            document.getElementById('detModel').innerText = d.model || "-";
            document.getElementById('detSerial').innerText = d.serial || "-";
            document.getElementById('detLocation').innerText = d.location || "-";
            document.getElementById('detVendor').innerText = d.vendor || "-";
            document.getElementById('detProvider').innerText = d.provider || "-";
            document.getElementById('detContact').innerText = d.contact || "-";
            document.getElementById('detStaff').innerText = d.staff || "-";
            document.getElementById('detStatusBadge').innerHTML = d.isOnline ? '<span style="color:green">‚óè S·∫¥N S√ÄNG HO·∫†T ƒê·ªòNG</span>' : '<span style="color:red">‚óè ƒêANG T·∫†M D·ª™NG THI·∫æT B·ªä</span>';

            const logs = d.logs ? Object.entries(d.logs) : [];
            const activeLogs = logs.filter(([id, l]) => !l.end);
            const taskList = document.getElementById('currentTaskList'); taskList.innerHTML = "";
            activeLogs.forEach(([lId, lData]) => {
                taskList.innerHTML += `<div class="task-item"><div><b>${lData.type}: ${lData.tech}</b><br><small>${lData.start}</small></div><button class="btn" style="background:green; color:white; padding:5px 10px;" onclick="finishWork('${lId}')">HO√ÄN T·∫§T</button></div>`;
            });

            const hBT = document.getElementById('histBT'); const hSM = document.getElementById('histSM');
            hBT.innerHTML = ""; hSM.innerHTML = "";
            logs.reverse().forEach(([id, l]) => {
                const card = `<div class="log-entry">
                    <div class="log-actions"><i class="fas fa-edit" style="color:blue" onclick="openEditLog('${id}')"></i> &nbsp; <i class="fas fa-trash" style="color:red" onclick="deleteLog('${id}')"></i></div>
                    <b>${l.tech}</b><br><small>${l.start} ‚Üí ${l.end || '...'}</small><br><span>${l.note}</span>
                </div>`;
                if(l.type === 'B·∫£o tr√¨') hBT.innerHTML += card; else hSM.innerHTML += card;
            });
            document.getElementById('detailModal').style.display = 'flex';
        }

        async function startWork(type) {
            let tech = prompt("T√™n k·ªπ s∆∞ th·ª±c hi·ªán:"); let note = type === 'SM' ? prompt("L√Ω do s·ª≠a ch·ªØa:") : "B·∫£o tr√¨ ƒë·ªãnh k·ª≥ thi·∫øt b·ªã";
            if(tech) {
                const log = { type: type==='BT'?'B·∫£o tr√¨':'S·ª≠a m√°y', tech, note, start: new Date().toLocaleString('vi-VN'), end: null };
                await fetch(`${API_URL}/${activeKey}/isOnline.json`, { method: 'PUT', body: "false" });
                await fetch(`${API_URL}/${activeKey}/logs.json`, { method: 'POST', body: JSON.stringify(log) });
                await loadData(true);
            }
        }

        async function finishWork(id) {
            const logs = Object.values(deviceData[activeKey].logs);
            if(logs.filter(l => !l.end).length === 1) await fetch(`${API_URL}/${activeKey}/isOnline.json`, { method: 'PUT', body: "true" });
            await fetch(`${API_URL}/${activeKey}/logs/${id}/end.json`, { method: 'PUT', body: JSON.stringify(new Date().toLocaleString('vi-VN')) });
            await loadData(true);
        }

        function openEditFromDetail() {
            const d = deviceData[activeKey]; document.getElementById('editKey').value = activeKey;
            document.getElementById('fName').value = d.name; document.getElementById('fId').value = d.id; document.getElementById('fGroup').value = d.group;
            document.getElementById('fModel').value = d.model || ""; document.getElementById('fSerial').value = d.serial || "";
            document.getElementById('fLocation').value = d.location || ""; 
            document.getElementById('fVendor').value = d.vendor || ""; document.getElementById('fProvider').value = d.provider || "";
            document.getElementById('fContact').value = d.contact || ""; document.getElementById('fStaff').value = d.staff || ""; 
            document.getElementById('detailModal').style.display = 'none'; document.getElementById('formModal').style.display = 'flex';
        }

        function printLabel() {
            const d = deviceData[activeKey];
            const qrLink = WEB_URL + "?id=" + d.id;
            const qrSrc = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrLink)}`;
            const win = window.open('', '', 'width=450,height=550');
            win.document.write(`<html><body style="text-align:center; font-family:Times New Roman; border:3px solid #000; padding:20px; border-radius:15px;">
                <h2 style="margin:0">BV UNG B∆Ø·ªöU CS2</h2><h3>${d.name}</h3><img src="${qrSrc}" width="200"><br>
                <p>M√£ ID: <b>${d.id}</b> | Model: ${d.model}</p><p><i>Qu√©t m√£ ƒë·ªÉ truy c·∫≠p h·ªá th·ªëng tr·ª±c tuy·∫øn</i></p>
                <script>setTimeout(()=>{window.print(); window.close();},500);<\/script></body></html>`);
        }

        function openEditLog(id) {
            editingLogId = id; const log = deviceData[activeKey].logs[id];
            document.getElementById('elTech').value = log.tech;
            document.getElementById('elNote').value = log.note || "";
            document.getElementById('elStart').value = log.start;
            document.getElementById('elEnd').value = log.end || "";
            document.getElementById('editLogModal').style.display = 'flex';
        }

        async function saveEditedLog() {
            const upd = { tech: document.getElementById('elTech').value, note: document.getElementById('elNote').value, start: document.getElementById('elStart').value, end: document.getElementById('elEnd').value };
            await fetch(`${API_URL}/${activeKey}/logs/${editingLogId}.json`, { method: 'PATCH', body: JSON.stringify(upd) });
            document.getElementById('editLogModal').style.display = 'none';
            await loadData(true);
        }

        async function deleteLog(id) { if(confirm("X√≥a vƒ©nh vi·ªÖn d√≤ng nh·∫≠t k√Ω n√†y?")) { await fetch(`${API_URL}/${activeKey}/logs/${id}.json`, { method: 'DELETE' }); await loadData(true); } }
        function showDashboard() { document.getElementById('mainDashboard').style.display='grid'; document.getElementById('tableArea').style.display='none'; document.getElementById('globalAddBtn').style.display='none'; }
        function setFilter(f) { currentFilter=f; document.getElementById('mainDashboard').style.display='none'; document.getElementById('tableArea').style.display='block'; document.getElementById('globalAddBtn').style.display = f === 'all' ? 'block' : 'none'; renderTable(); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function toggleHistory(s) { document.getElementById('historyLayer').style.display = s ? 'block' : 'none'; }
        async function deleteDevice(k) { if(confirm("X√≥a to√†n b·ªô thi·∫øt b·ªã n√†y kh·ªèi h·ªá th·ªëng?")) { await fetch(`${API_URL}/${k}.json`, { method: 'DELETE' }); loadData(); } }
        function openAddModal() { document.getElementById('deviceForm').reset(); document.getElementById('fStaff').value = "Tr∆∞∆°ng C√¥ng H·∫≠u (0934187801)"; document.getElementById('formModal').style.display = 'flex'; }
        
        document.getElementById('deviceForm').onsubmit = async (e) => {
            e.preventDefault(); const key = document.getElementById('editKey').value;
            const payload = {
                name: document.getElementById('fName').value, id: document.getElementById('fId').value, group: document.getElementById('fGroup').value,
                model: document.getElementById('fModel').value, serial: document.getElementById('fSerial').value, location: document.getElementById('fLocation').value,
                vendor: document.getElementById('fVendor').value, provider: document.getElementById('fProvider').value,
                contact: document.getElementById('fContact').value, staff: document.getElementById('fStaff').value,
                isOnline: key ? deviceData[key].isOnline : true, logs: key ? (deviceData[key].logs || {}) : {}
            };
            if (key) await fetch(`${API_URL}/${key}.json`, { method: 'PUT', body: JSON.stringify(payload) });
            else await fetch(`${API_URL}.json`, { method: 'POST', body: JSON.stringify(payload) });
            closeModals(); loadData();
        };
        loadData();
    </script>
</body>
</html>
